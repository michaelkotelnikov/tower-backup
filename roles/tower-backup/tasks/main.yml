---
- name: "Execute the Ansible Tower backup"
  command: "./setup.sh -b"
  args:
    chdir: "{{ ansible_tower_directory }}"

- name: "Copy backup file to a remote file server"
  copy:
    remote_src: yes
    src: "{{ ansible_tower_directory }}/tower-backup-latest.tar.gz"
    dest: "{{ web_dir }}"

- name: "Verify that jobs are not running on the destination tower"
  shell: "while [ $(curl -k -X GET --user {{ tower_username }}:{{ tower_password }} https://10.35.97.144/api/v2/jobs/?status=running -L | jq '.count') -ne 0 ]; do sleep 1; echo 'A job is running - Re-checking'; done"

